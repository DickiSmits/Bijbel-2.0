<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <title>Reader Opmaak Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .verse { padding: 0.5rem; border-radius: 4px; margin-bottom: 0.5rem; }
        .verse-number { font-weight: bold; color: #2c5282; margin-right: 0.5rem; }
        .verse-text { font-family: Georgia, serif; }
        .has-opmaak { background: #e3f2fd; }
        .no-opmaak { background: #f5f5f5; }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h3>üîç Reader Opmaak Test</h3>
        
        <div class="card mb-3">
            <div class="card-header">
                <h5>Selecteer Profiel en Boek</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label>Profiel:</label>
                        <select id="profileSelect" class="form-select">
                            <option value="">Laden...</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label>Boek:</label>
                        <select id="bookSelect" class="form-select">
                            <option value="">Selecteer eerst profiel</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label>Hoofdstuk:</label>
                        <select id="chapterSelect" class="form-select">
                            <option value="">Selecteer eerst boek</option>
                        </select>
                    </div>
                </div>
                <button class="btn btn-primary mt-3" onclick="loadVerses()">Laad Verzen</button>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header d-flex justify-content-between">
                <span>Resultaat</span>
                <span id="opmaakStats" class="badge bg-info"></span>
            </div>
            <div class="card-body" id="versesContainer">
                <p class="text-muted">Selecteer profiel, boek en hoofdstuk om te testen...</p>
            </div>
        </div>
    </div>
    
    <script>
        let currentProfile = null;
        let currentBook = null;
        let currentChapter = null;
        
        // Load profiles on page load
        async function loadProfiles() {
            try {
                const profiles = await fetch('./?api=profiles').then(r => r.json());
                const select = document.getElementById('profileSelect');
                select.innerHTML = '<option value="">Geen profiel (originele tekst)</option>';
                
                profiles.forEach(profile => {
                    const option = document.createElement('option');
                    option.value = profile.Profiel_ID;
                    option.textContent = `${profile.Profiel_Naam} (ID: ${profile.Profiel_ID})`;
                    select.appendChild(option);
                });
                
                console.log('Loaded profiles:', profiles);
            } catch (error) {
                console.error('Error loading profiles:', error);
                document.getElementById('profileSelect').innerHTML = '<option>ERROR loading profiles</option>';
            }
        }
        
        // Load books
        async function loadBooks() {
            try {
                const books = await fetch('./?api=books').then(r => r.json());
                const select = document.getElementById('bookSelect');
                select.innerHTML = '<option value="">Kies een boek...</option>';
                
                books.forEach(book => {
                    const option = document.createElement('option');
                    option.value = book.Bijbelboeknaam;
                    option.textContent = book.Bijbelboeknaam;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading books:', error);
            }
        }
        
        // Load chapters
        async function loadChapters(boek) {
            try {
                const chapters = await fetch(`./?api=chapters&boek=${encodeURIComponent(boek)}`).then(r => r.json());
                const select = document.getElementById('chapterSelect');
                select.innerHTML = '<option value="">Kies hoofdstuk...</option>';
                
                chapters.forEach(ch => {
                    const option = document.createElement('option');
                    option.value = ch.Hoofdstuknummer;
                    option.textContent = `Hoofdstuk ${ch.Hoofdstuknummer}`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading chapters:', error);
            }
        }
        
        // Load verses - EXACT zoals reader.js doet!
        async function loadVerses() {
            const container = document.getElementById('versesContainer');
            const statsEl = document.getElementById('opmaakStats');
            
            if (!currentBook || !currentChapter) {
                container.innerHTML = '<p class="text-danger">Selecteer eerst boek en hoofdstuk!</p>';
                return;
            }
            
            container.innerHTML = '<div class="text-center"><div class="spinner-border"></div><p>Laden...</p></div>';
            
            try {
                // Build URL EXACT zoals reader.js
                let url = `./?api=verses&boek=${encodeURIComponent(currentBook)}&hoofdstuk=${currentChapter}&limit=20`;
                if (currentProfile) {
                    url += `&profiel_id=${currentProfile}`;
                }
                
                console.log('Fetching:', url);
                
                const verses = await fetch(url).then(r => r.json());
                
                console.log('Received verses:', verses);
                
                // Count opmaak
                let withOpmaak = 0;
                let withoutOpmaak = 0;
                
                container.innerHTML = '';
                
                verses.forEach(verse => {
                    const hasOpmaak = verse.Opgemaakte_Tekst && verse.Opgemaakte_Tekst.trim() !== '';
                    
                    if (hasOpmaak) withOpmaak++;
                    else withoutOpmaak++;
                    
                    const verseDiv = document.createElement('div');
                    verseDiv.className = 'verse ' + (hasOpmaak ? 'has-opmaak' : 'no-opmaak');
                    
                    const number = document.createElement('span');
                    number.className = 'verse-number';
                    number.textContent = verse.Versnummer;
                    
                    const text = document.createElement('span');
                    text.className = 'verse-text';
                    // EXACT zoals reader.js
                    text.innerHTML = verse.Opgemaakte_Tekst || verse.Tekst;
                    
                    verseDiv.appendChild(number);
                    verseDiv.appendChild(text);
                    
                    container.appendChild(verseDiv);
                });
                
                statsEl.textContent = `${withOpmaak} met opmaak, ${withoutOpmaak} zonder`;
                statsEl.className = withOpmaak > 0 ? 'badge bg-success' : 'badge bg-warning';
                
            } catch (error) {
                console.error('Error loading verses:', error);
                container.innerHTML = `<p class="text-danger">ERROR: ${error.message}</p>`;
            }
        }
        
        // Event listeners
        document.getElementById('profileSelect').addEventListener('change', function(e) {
            currentProfile = e.target.value || null;
            console.log('Selected profile:', currentProfile);
            if (!currentProfile) {
                loadBooks();
            } else {
                loadBooks();
            }
        });
        
        document.getElementById('bookSelect').addEventListener('change', function(e) {
            currentBook = e.target.value;
            console.log('Selected book:', currentBook);
            if (currentBook) {
                loadChapters(currentBook);
            }
        });
        
        document.getElementById('chapterSelect').addEventListener('change', function(e) {
            currentChapter = e.target.value;
            console.log('Selected chapter:', currentChapter);
        });
        
        // Initialize
        loadProfiles();
    </script>
</body>
</html>
